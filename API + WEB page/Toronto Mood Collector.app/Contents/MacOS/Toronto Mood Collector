#!/bin/bash

# Toronto Mood & Events Collector - Executable Script
# This script automatically sets up the environment and runs the mood tagging collection + event discovery

# Get the directory where this script is located
SCRIPT_DIR="$(dirname "$0")"
# Navigate to the main app directory (3 levels up from MacOS folder)
APP_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"

# Function to show notifications
show_notification() {
    osascript -e "display notification \"$1\" with title \"Toronto Mood & Events Collector\" sound name \"Glass\""
}

# Function to show dialog
show_dialog() {
    osascript -e "display dialog \"$1\" with title \"Toronto Mood & Events Collector\" buttons {\"OK\"} default button \"OK\""
}

# Function to show progress
show_progress() {
    echo "ðŸŽ­ Toronto Hidden Gems & Events Finder"
    echo "=" * 50
    echo "$1"
}

# Change to the app directory
cd "$APP_DIR"

# Show initial notification
show_notification "Starting Toronto Mood & Events Collector..."

# Create a log file
LOG_FILE="$APP_DIR/mood_events_collection.log"
echo "=== Toronto Mood & Events Collector Started: $(date) ===" > "$LOG_FILE"

{
    show_progress "ðŸ“ Setting up environment..."
    
    # Check if Python 3 is available
    if ! command -v python3 &> /dev/null; then
        echo "âŒ Error: Python 3 is not installed"
        show_dialog "Error: Python 3 is required but not found. Please install Python 3 and try again."
        exit 1
    fi
    
    # Create virtual environment if it doesn't exist
    if [ ! -d "venv" ]; then
        show_progress "ðŸ”§ Creating Python virtual environment..."
        python3 -m venv venv
    fi
    
    # Activate virtual environment
    show_progress "âš¡ Activating virtual environment..."
    source venv/bin/activate
    
    # Install/update requirements
    show_progress "ðŸ“¦ Installing/updating dependencies..."
    if [ -f "config/requirements.txt" ]; then
        python3 -m pip install -r config/requirements.txt --quiet
    else
        echo "âš ï¸  Warning: config/requirements.txt not found, installing basic requirements..."
        python3 -m pip install -r requirements.txt --quiet
    fi
    
    show_notification "Dependencies installed. Starting data collection..."
    
    # Run the mood tagging collection
    show_progress "ðŸŽ¯ Collecting recommendation data with mood tagging..."
    python3 scripts/run.py recommendations
    
    show_progress "ðŸ’Ž Finding hidden gems with mood analysis..."
    python3 scripts/run.py find-recs
    
    show_notification "Mood collection complete! Starting event discovery..."
    
    # Run event collection and finding
    show_progress "ðŸŽ­ Collecting events from Reddit and Ticketmaster..."
    python3 scripts/run.py events
    
    show_progress "ðŸŽª Finding hidden gem events..."
    python3 scripts/run.py find-events
    
    show_notification "âœ… Collection complete! Check the data folder for results."
    
    echo "âœ¨ Collection complete! Results saved to data folder."
    echo "ðŸ“Š You can now run the web app to view mood-tagged results and events."
    echo ""
    echo "To view results in web browser, run:"
    echo "  python3 web_app.py"
    echo ""
    echo "ðŸ“ Web app will be available at: http://localhost:8000"
    echo "ðŸ’Ž Hidden Gems: http://localhost:8000/gems"
    echo "ðŸŽ­ Events: http://localhost:8000/events"
    echo ""
    echo "Press any key to close..."
    read -n 1
    
} 2>&1 | tee -a "$LOG_FILE"

# Show completion dialog
show_dialog "Mood & Events collection complete! ðŸŽ‰

âœ… Reddit data collected with mood analysis
ðŸ’Ž Hidden gems found and tagged
ðŸŽ­ Events discovered from Reddit & Ticketmaster
ðŸ“„ Results saved to data folder

What you can explore:
â€¢ Hidden Gem Restaurants (mood-tagged)
â€¢ Upcoming Events with mood analysis
â€¢ Food festivals, art shows, music events
â€¢ Budget-friendly and romantic options

Check the log file for details:
$LOG_FILE

To view in browser, run: python3 web_app.py" 