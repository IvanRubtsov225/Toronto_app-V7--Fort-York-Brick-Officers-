{% extends "base.html" %}

{% block title %}Hidden Gems Map - Toronto Hidden Gems{% endblock %}

{% block content %}
<div class="gems-explorer">
    <!-- Hero Section -->
    <section class="hero gems-hero fade-in">
        <div class="container">
            <h1 class="display-4 mb-3">Toronto's Hidden Gems Map</h1>
            <p class="lead mb-4 slide-up">Explore all the best-kept secrets in Toronto on an interactive map</p>
        </div>
    </section>

    <div class="container-fluid my-5">
        <div class="row">
            <!-- Filters Card -->
            <div class="col-lg-3 mb-4">
                <div class="card filter-card animated-fade-in">
                    <div class="card-body">
                        <h4 class="mb-4">Filters</h4>
                        <!-- Mood Tags -->
                        <div class="mb-3">
                            <label class="form-label">Selected Moods</label>
                            <div id="selected-moods" class="mb-2"></div>
                        </div>
                        <!-- Mood Buttons -->
                        <div class="mb-4">
                            <label class="form-label">Mood</label>
                            <div class="mood-filter-buttons" id="mood-filter">
                                <button class="btn btn-mood" data-mood="romantic">üíë Romantic</button>
                                <button class="btn btn-mood" data-mood="adventure">üåü Adventure</button>
                                <button class="btn btn-mood" data-mood="relaxing">üåø Relaxing</button>
                                <button class="btn btn-mood" data-mood="cultural">üé≠ Cultural</button>
                                <button class="btn btn-mood" data-mood="foodie">üçΩÔ∏è Foodie</button>
                                <button class="btn btn-mood" data-mood="nightlife">üåô Nightlife</button>
                                <button class="btn btn-mood" data-mood="budget">üí∞ Budget</button>
                            </div>
                        </div>
                        <!-- Show All Toggle -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="show-all-gems">
                            <label class="form-check-label" for="show-all-gems">
                                Show all gems
                            </label>
                        </div>
                        <!-- Search -->
                        <div class="mb-4">
                            <label class="form-label">Search</label>
                            <input type="text" id="search-input" class="form-control" placeholder="Search by name or address...">
                        </div>
                        <!-- Type -->
                        <div class="mb-4">
                            <label class="form-label">Type</label>
                            <select id="type-filter" class="form-select">
                                <option value="all">All Types</option>
                                <option value="Restaurant">Restaurant</option>
                                <option value="Cafe">Cafe</option>
                                <option value="Bar">Bar</option>
                                <option value="Food Take Out">Take Out</option>
                                <option value="Bakery">Bakery</option>
                            </select>
                        </div>
                        <!-- Score -->
                        <div class="mb-4">
                            <label class="form-label">Minimum Score</label>
                            <input type="range" class="form-range" id="score-filter" min="0" max="100" value="0">
                            <div class="score-value text-center mt-1">0</div>
                        </div>
                    </div>
                </div>
                <!-- Visible Gems List (animated) -->
                <div id="gems-list" class="mt-4"></div>
            </div>
            <!-- Map -->
            <div class="col-lg-9">
                <div class="card map-card animated-fade-in">
                    <div class="card-body p-0">
                        <div id="map" style="height: 650px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .gems-hero {
        background: linear-gradient(135deg, var(--toronto-blue) 0%, var(--apple-blue) 100%);
        padding: 5rem 0 3rem 0;
        color: white;
        border-radius: 0 0 32px 32px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }
    .filter-card {
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        background: rgba(255,255,255,0.95);
        position: sticky;
        top: 2rem;
        animation: fadeIn 1s;
    }
    .map-card {
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        animation: fadeIn 1.2s;
    }
    .mood-filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .btn-mood {
        border-radius: 20px;
        background: var(--apple-light-gray);
        color: var(--primary-color);
        font-weight: 500;
        transition: all 0.2s;
        border: 1px solid var(--apple-gray);
        margin-bottom: 0.25rem;
    }
    .btn-mood.active, .btn-mood:active {
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        color: white;
        border-color: var(--primary-color);
        transform: scale(1.08);
    }
    .score-value {
        color: var(--medium-text);
        font-size: 0.95rem;
    }
    #selected-moods {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .selected-mood-tag {
        background: var(--apple-light-gray);
        border-radius: 20px;
        padding: 0.5rem 1rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .selected-mood-tag:hover {
        background: var(--apple-gray);
        color: white;
    }
    #gems-list {
        max-height: 350px;
        overflow-y: auto;
        margin-top: 1rem;
        animation: fadeIn 1.2s;
    }
    .gem-item {
        padding: 1rem;
        border-radius: 12px;
        background: white;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.2s;
        cursor: pointer;
        animation: slideUp 0.7s;
    }
    .gem-item:hover {
        background: var(--apple-blue);
        color: white;
        transform: translateX(5px);
    }
    /* Animations */
    .fade-in { animation: fadeIn 1s; }
    .slide-up { animation: slideUp 1s; }
    .animated-fade-in { animation: fadeIn 1.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Mood gradients and emojis (for tag UI)
const moodStyles = {
    romantic: { emoji: 'üíë' },
    foodie: { emoji: 'üçΩÔ∏è' },
    adventure: { emoji: 'üåü' },
    relaxing: { emoji: 'üåø' },
    cultural: { emoji: 'üé≠' },
    budget: { emoji: 'üí∞' },
    nightlife: { emoji: 'üåô' }
};
let map;
let markers = [];
let allGems = [];
let selectedMoods = new Set();

function fetchGems() {
    fetch('/api/gems/all')
        .then(res => res.json())
        .then(data => {
            allGems = data.data;
            updateMap();
        });
}

function updateSelectedMoodsUI() {
    const container = document.getElementById('selected-moods');
    container.innerHTML = '';
    selectedMoods.forEach(mood => {
        const tag = document.createElement('div');
        tag.className = 'selected-mood-tag';
        tag.innerHTML = `
            ${moodStyles[mood]?.emoji || 'üè∑Ô∏è'} ${mood}
            <span class="remove-mood">√ó</span>
        `;
        tag.onclick = () => toggleMood(mood);
        container.appendChild(tag);
    });
}

function toggleMood(mood) {
    if (selectedMoods.has(mood)) {
        selectedMoods.delete(mood);
    } else {
        selectedMoods.add(mood);
    }
    updateSelectedMoodsUI();
    updateMap();
}

function updateMap() {
    // Clear existing markers
    markers.forEach(marker => marker.remove());
    markers = [];
    // Filter gems
    const showAll = document.getElementById('show-all-gems').checked;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const selectedType = document.getElementById('type-filter').value;
    const minScore = parseInt(document.getElementById('score-filter').value);
    let filtered = allGems.filter(gem => {
        const name = gem.name.toLowerCase();
        const address = (gem.address || '').toLowerCase();
        const type = gem.type;
        const score = parseFloat(gem.hidden_gem_score);
        const gemMoods = (gem.mood_tags || '').toLowerCase().split(',').map(m => m.trim());
        let visible = (name.includes(searchTerm) || address.includes(searchTerm)) && score >= minScore && (selectedType === 'all' || type.includes(selectedType));
        if (!showAll && selectedMoods.size > 0) {
            visible = visible && Array.from(selectedMoods).some(mood => gemMoods.includes(mood));
        }
        return visible;
    });
    updateGemsList(filtered);
    filtered.forEach(gem => {
        if (gem.latitude && gem.longitude) {
            const marker = L.marker([gem.latitude, gem.longitude])
                .bindPopup(`
                    <strong>${gem.name}</strong><br>
                    ${gem.type}<br>
                    Score: ${gem.hidden_gem_score.toFixed(1)}<br>
                    <small>${gem.mood_tags}</small>
                `);
            marker.addTo(map);
            markers.push(marker);
        }
    });
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

function updateGemsList(gems) {
    const container = document.getElementById('gems-list');
    container.innerHTML = '';
    gems.slice(0, 10).forEach(gem => {
        const item = document.createElement('div');
        item.className = 'gem-item';
        item.innerHTML = `<h5>${gem.name}</h5><p class='mb-1'><small>${gem.type}</small></p><p class='mb-0'><span class='badge bg-primary'>${gem.hidden_gem_score.toFixed(1)}</span> <small class='text-muted'>${gem.mood_tags}</small></p>`;
        item.onclick = () => {
            if (gem.latitude && gem.longitude) {
                map.setView([gem.latitude, gem.longitude], 16);
                markers.forEach(marker => {
                    if (marker.getLatLng().lat === gem.latitude && marker.getLatLng().lng === gem.longitude) {
                        marker.openPopup();
                    }
                });
            }
        };
        container.appendChild(item);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    map = L.map('map').setView([43.6532, -79.3832], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    fetchGems();
    // Mood button events
    document.querySelectorAll('.btn-mood').forEach(btn => {
        btn.addEventListener('click', function() {
            toggleMood(this.dataset.mood);
            this.classList.toggle('active');
        });
    });
    document.getElementById('show-all-gems').addEventListener('change', updateMap);
    document.getElementById('search-input').addEventListener('input', updateMap);
    document.getElementById('type-filter').addEventListener('change', updateMap);
    document.getElementById('score-filter').addEventListener('input', function() {
        this.nextElementSibling.textContent = this.value;
        updateMap();
    });
});
</script>
{% endblock %} 