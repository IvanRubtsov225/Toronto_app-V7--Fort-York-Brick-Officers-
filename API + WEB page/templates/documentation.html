{% extends "base.html" %}

{% block title %}API Documentation - Toronto Hidden Gems{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 fw-bold text-primary">📚 API Documentation</h1>
            <p class="lead text-muted">Complete guide to accessing Toronto Hidden Gems data programmatically</p>
        </div>
    </div>
</section>

<!-- Quick Start -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-rocket"></i> Quick Start</h3>
                    </div>
                    <div class="card-body">
                        <p>The Toronto Hidden Gems API provides RESTful access to our curated database of local restaurant recommendations. All endpoints return JSON data and support CORS for browser-based applications.</p>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Base URL:</strong> <code>http://localhost:8000/api</code>
                        </div>
                        
                        <h5>Example Request</h5>
                        <pre class="bg-dark text-light p-3 rounded"><code>curl -X GET "http://localhost:8000/api/gems/top?limit=5" \
     -H "Accept: application/json"</code></pre>
                        
                        <h5>Example Response</h5>
                        <pre class="bg-light p-3 rounded"><code>{
  "status": "success",
  "count": 5,
  "data": [
    {
      "name": "THE LOOK OUT",
      "address": "909 LAKE SHORE BLVD W",
      "type": "Cocktail Bar / Beverage Room",
      "hidden_gem_score": 85.31,
      "dinesafe_score": 100.0,
      "mood_tags": "Romantic, Nightlife",
      "latitude": 43.62933,
      "longitude": -79.41512
    }
  ]
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Endpoints -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold text-primary">🔗 API Endpoints</h2>
        
        <!-- Get All Gems -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get All Hidden Gems</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/gems</code></p>
                <p>Retrieve all hidden gems in the database with optional pagination.</p>
                
                <h6>Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>Maximum number of results to return</td>
                                <td><code>?limit=20</code></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems?limit=10</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems?limit=3')">
                            <i class="bi bi-play"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Top Gems -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Top-Rated Gems</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/gems/top</code></p>
                <p>Retrieve the highest-rated hidden gems, sorted by hidden gem score.</p>
                
                <h6>Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>Number of top gems to return</td>
                                <td>10</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems/top?limit=5</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems/top?limit=3')">
                            <i class="bi bi-play"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Gems by Mood -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Gems by Mood</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/gems/mood/{mood}</code></p>
                <p>Filter hidden gems by mood or vibe (romantic, foodie, budget, etc.).</p>
                
                <h6>Path Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Options</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>mood</code></td>
                                <td>string</td>
                                <td>Mood category to filter by</td>
                                <td>romantic, foodie, budget, nightlife, family, cultural, relaxing</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Query Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>Maximum number of results</td>
                                <td>10</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Examples</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Romantic places:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems/mood/romantic</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems/mood/romantic?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                    <div class="col-md-6">
                        <strong>Budget-friendly:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems/mood/budget</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems/mood/budget?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Gems by Type -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Gems by Type</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/gems/type/{type}</code></p>
                <p>Filter hidden gems by establishment type (restaurant, cafe, bakery, etc.).</p>
                
                <h6>Path Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Examples</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>type</code></td>
                                <td>string</td>
                                <td>Establishment type to filter by</td>
                                <td>restaurant, cafe, bakery, bar, "take out"</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Examples</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Restaurants:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems/type/restaurant</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems/type/restaurant?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                    <div class="col-md-6">
                        <strong>Bakeries:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/gems/type/bakery</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/gems/type/bakery?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Statistics</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/stats</code></p>
                <p>Get overall statistics about the hidden gems database.</p>
                
                <h6>Response Fields</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>total_gems</code></td>
                                <td>integer</td>
                                <td>Total number of hidden gems</td>
                            </tr>
                            <tr>
                                <td><code>average_score</code></td>
                                <td>float</td>
                                <td>Average hidden gem score</td>
                            </tr>
                            <tr>
                                <td><code>average_sentiment</code></td>
                                <td>float</td>
                                <td>Average sentiment score</td>
                            </tr>
                            <tr>
                                <td><code>mood_distribution</code></td>
                                <td>object</td>
                                <td>Count of gems by mood category</td>
                            </tr>
                            <tr>
                                <td><code>score_ranges</code></td>
                                <td>object</td>
                                <td>Count of gems by score range</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/stats</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/stats')">
                            <i class="bi bi-play"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Events API Endpoints -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold text-secondary">🎭 Events API Endpoints</h2>
        <p class="text-center text-muted mb-5">Access Toronto's most exciting events, from concerts to cultural gatherings</p>
        
        <!-- Get All Events -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get All Events</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/events</code></p>
                <p>Retrieve all events in Toronto with Reddit buzz scores and Ticketmaster integration.</p>
                
                <h6>Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>Maximum number of events to return</td>
                                <td><code>?limit=20</code></td>
                            </tr>
                            <tr>
                                <td><code>mood</code></td>
                                <td>string</td>
                                <td>Filter by mood (romantic, energetic, cultural, etc.)</td>
                                <td><code>?mood=cultural</code></td>
                            </tr>
                            <tr>
                                <td><code>type</code></td>
                                <td>string</td>
                                <td>Filter by event type (concert, festival, sports, etc.)</td>
                                <td><code>?type=concert</code></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Response Fields</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>name</code></td>
                                <td>string</td>
                                <td>Event name</td>
                            </tr>
                            <tr>
                                <td><code>venue</code></td>
                                <td>string</td>
                                <td>Venue name and location</td>
                            </tr>
                            <tr>
                                <td><code>date</code></td>
                                <td>string</td>
                                <td>Event date (YYYY-MM-DD)</td>
                            </tr>
                            <tr>
                                <td><code>time</code></td>
                                <td>string</td>
                                <td>Event start time</td>
                            </tr>
                            <tr>
                                <td><code>price_range</code></td>
                                <td>string</td>
                                <td>Price category (Free, Budget, Premium)</td>
                            </tr>
                            <tr>
                                <td><code>mood_tags</code></td>
                                <td>string</td>
                                <td>Comma-separated mood categories</td>
                            </tr>
                            <tr>
                                <td><code>reddit_buzz_score</code></td>
                                <td>float</td>
                                <td>Reddit community excitement score (0-100)</td>
                            </tr>
                            <tr>
                                <td><code>hidden_gem_score</code></td>
                                <td>float</td>
                                <td>Overall event hidden gem score</td>
                            </tr>
                            <tr>
                                <td><code>ticketmaster_url</code></td>
                                <td>string</td>
                                <td>Direct link to purchase tickets</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/events?limit=5</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/events?limit=3')">
                            <i class="bi bi-play"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Events by Mood -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Events by Mood</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/events/mood/{mood}</code></p>
                <p>Filter events by mood or vibe (romantic, energetic, cultural, artistic, etc.).</p>
                
                <h6>Path Parameters</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Options</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>mood</code></td>
                                <td>string</td>
                                <td>Mood category to filter by</td>
                                <td>romantic, energetic, cultural, artistic, foodie, nightlife, family, outdoor, free, budget</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Examples</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Cultural events:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/events/mood/cultural</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/events/mood/cultural?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                    <div class="col-md-6">
                        <strong>Free events:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/events/mood/free</code></pre>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/events/mood/free?limit=3')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Get Events Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Get Events Statistics</h4>
                    <span class="badge bg-success">GET</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/events/stats</code></p>
                <p>Get overall statistics about Toronto events.</p>
                
                <h6>Response Fields</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>total_events</code></td>
                                <td>integer</td>
                                <td>Total number of events</td>
                            </tr>
                            <tr>
                                <td><code>free_events</code></td>
                                <td>integer</td>
                                <td>Number of free events</td>
                            </tr>
                            <tr>
                                <td><code>average_reddit_buzz</code></td>
                                <td>float</td>
                                <td>Average Reddit buzz score</td>
                            </tr>
                            <tr>
                                <td><code>average_hidden_gem_score</code></td>
                                <td>float</td>
                                <td>Average hidden gem score</td>
                            </tr>
                            <tr>
                                <td><code>mood_distribution</code></td>
                                <td>object</td>
                                <td>Count of events by mood category</td>
                            </tr>
                            <tr>
                                <td><code>upcoming_events</code></td>
                                <td>integer</td>
                                <td>Events happening in the next 30 days</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>GET /api/events/stats</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-primary btn-sm" onclick="testEndpoint('/api/events/stats')">
                            <i class="bi bi-play"></i> Test API
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collect Events Data -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Trigger Events Data Collection</h4>
                    <span class="badge bg-warning">POST</span>
                </div>
            </div>
            <div class="card-body">
                <p><code>/api/collect-events</code></p>
                <p>Manually trigger collection of fresh events data from Ticketmaster and Reddit.</p>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This endpoint may take several minutes to complete as it collects data from multiple sources.
                </div>
                
                <h6>Response</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>status</code></td>
                                <td>string</td>
                                <td>Collection status ("started", "completed", "error")</td>
                            </tr>
                            <tr>
                                <td><code>ticketmaster_events</code></td>
                                <td>integer</td>
                                <td>Number of events collected from Ticketmaster</td>
                            </tr>
                            <tr>
                                <td><code>reddit_events</code></td>
                                <td>integer</td>
                                <td>Number of events found on Reddit</td>
                            </tr>
                            <tr>
                                <td><code>processing_time</code></td>
                                <td>string</td>
                                <td>Time taken to complete collection</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>Example</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Request:</strong>
                        <pre class="bg-dark text-light p-2 rounded small"><code>POST /api/collect-events</code></pre>
                    </div>
                    <div class="col-md-6">
                        <strong>Try it:</strong>
                        <button class="btn btn-outline-warning btn-sm" onclick="testCollectEvents()">
                            <i class="bi bi-cloud-download"></i> Collect Events
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FLUTTER API BUTTON: Toronto Magic! -->
<div class="text-center my-5">
    <button id="flutterApiBtn" class="btn btn-lg btn-primary toronto-btn shadow-lg" style="font-size:2rem; border-radius: 40px; background: linear-gradient(90deg, #0072CE 0%, #41B6E6 100%); animation: bounce 1.2s infinite alternate;">
        🏙️🍁 FLUTTER API: Press Me for Toronto Magic! 🍁🏙️
    </button>
    <div id="flutterApiEndpoints" style="display:none; margin-top:2rem;">
        <div class="card border-primary animated fadeInUp">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Flutter Endpoints (Toronto Style!)</h4>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span style="font-size:1.5rem;">🎲</span>
                        <code class="bg-light p-2 rounded">GET /api/flutter/random-gem</code>
                        <span class="ms-2">- Get a random hidden gem from the 6ix!</span>
                    </li>
                    <li class="mb-3">
                        <span style="font-size:1.5rem;">🌈</span>
                        <code class="bg-light p-2 rounded">GET /api/flutter/moods</code>
                        <span class="ms-2">- All the unique Toronto moods, eh!</span>
                    </li>
                </ul>
                <div class="text-center mt-3">
                    <span style="font-size:2rem;">🦫🗺️🍁🦫</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes bounce {
  0% { transform: translateY(0); }
  100% { transform: translateY(-18px) scale(1.08); }
}
.animated.fadeInUp {
  animation: fadeInUp 1s;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}
.toronto-btn:hover {
  background: linear-gradient(90deg, #41B6E6 0%, #0072CE 100%);
  color: #fff;
  transform: scale(1.08) rotate(-2deg);
  box-shadow: 0 8px 32px rgba(0,114,206,0.18);
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('flutterApiBtn');
    const endpoints = document.getElementById('flutterApiEndpoints');
    btn.addEventListener('click', function() {
        endpoints.style.display = 'block';
        endpoints.classList.add('fadeInUp');
        btn.innerHTML = '🍁✨ Welcome to the Toronto Flutter API! ✨🍁';
        btn.disabled = true;
        btn.style.background = 'linear-gradient(90deg, #41B6E6 0%, #0072CE 100%)';
        btn.style.color = '#fff';
        btn.style.transform = 'scale(1.12) rotate(2deg)';
    });
});

function testEndpoint(endpoint) {
    showLoading();
    
    fetch(endpoint)
        .then(response => {
            const status = response.status;
            const statusClass = status === 200 ? 'bg-success' : 'bg-danger';
            document.getElementById('responseStatus').className = `badge ${statusClass}`;
            document.getElementById('responseStatus').textContent = `${status} ${response.statusText}`;
            
            return response.json();
        })
        .then(data => {
            showResponse(JSON.stringify(data, null, 2));
        })
        .catch(error => {
            document.getElementById('responseStatus').className = 'badge bg-danger';
            document.getElementById('responseStatus').textContent = 'Error';
            showResponse(`Error: ${error.message}`);
        });
}

function testCustomEndpoint() {
    const endpoint = document.getElementById('apiUrl').value;
    if (endpoint) {
        testEndpoint(endpoint);
    }
}

function loadQuickTest() {
    const select = document.getElementById('quickTest');
    const endpoint = select.value;
    if (endpoint) {
        document.getElementById('apiUrl').value = endpoint;
        testEndpoint(endpoint);
    }
}

function showLoading() {
    document.getElementById('apiResponse').style.display = 'none';
    document.getElementById('apiLoading').style.display = 'block';
}

function showResponse(response) {
    document.getElementById('apiLoading').style.display = 'none';
    document.getElementById('responseBody').textContent = response;
    document.getElementById('apiResponse').style.display = 'block';
}

// Special function for testing collect events (POST request)
function testCollectEvents() {
    showLoading();
    
    fetch('/api/collect-events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        const status = response.status;
        const statusClass = status === 200 ? 'bg-success' : 'bg-danger';
        document.getElementById('responseStatus').className = `badge ${statusClass}`;
        document.getElementById('responseStatus').textContent = `${status} ${response.statusText}`;
        
        return response.json();
    })
    .then(data => {
        showResponse(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        document.getElementById('responseStatus').className = 'badge bg-danger';
        document.getElementById('responseStatus').textContent = 'Error';
        showResponse(`Error: ${error.message}`);
    });
}

// Syntax highlighting for code blocks
document.addEventListener('DOMContentLoaded', function() {
    // Add copy buttons to code blocks
    document.querySelectorAll('pre code').forEach(block => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2';
        button.innerHTML = '<i class="bi bi-clipboard"></i>';
        button.onclick = () => {
            navigator.clipboard.writeText(block.textContent);
            button.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-clipboard"></i>';
            }, 2000);
        };
        
        const container = block.closest('pre');
        container.style.position = 'relative';
        container.appendChild(button);
    });
});
</script>
<!-- END FLUTTER API BUTTON -->

<!-- Response Format -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold text-primary">📋 Response Format</h2>
        
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Standard Response</h5>
                    </div>
                    <div class="card-body">
                        <p>All API endpoints return a consistent JSON structure:</p>
                        <pre class="bg-light p-3 rounded"><code>{
  "status": "success",
  "count": 123,
  "data": [...]
}</code></pre>
                        
                        <h6>Response Fields</h6>
                        <ul>
                            <li><code>status</code>: Always "success" for successful requests</li>
                            <li><code>count</code>: Number of items returned</li>
                            <li><code>data</code>: Array of gem objects or statistics object</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Gem Object Structure</h5>
                    </div>
                    <div class="card-body">
                        <p>Each hidden gem contains the following fields:</p>
                        <pre class="bg-light p-3 rounded small"><code>{
  "name": "Restaurant Name",
  "address": "123 Street Name",
  "type": "Restaurant",
  "latitude": 43.6532,
  "longitude": -79.3832,
  "hidden_gem_score": 85.31,
  "dinesafe_score": 100.0,
  "recommendation_score": 87.05,
  "uniqueness_score": 85.0,
  "mention_count": 4,
  "avg_sentiment": 0.284,
  "mood_tags": "Romantic, Nightlife",
  "positive_indicators": 5,
  "negative_indicators": 0,
  "establishment_id": "10686092"
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Data Sources -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold text-primary">📊 Data Sources & Methodology</h2>
        
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="bi bi-reddit"></i> Reddit Analysis
                        </h5>
                        <p>We analyze Toronto food subreddits including:</p>
                        <ul>
                            <li>r/toronto</li>
                            <li>r/askTO</li>
                            <li>r/TorontoEats</li>
                            <li>r/TorontoEvents</li>
                        </ul>
                        <p>Our algorithm extracts restaurant mentions, sentiment, and "hidden gem" keywords to identify community favorites.</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-success">
                            <i class="bi bi-shield-check"></i> DineSafe Data
                        </h5>
                        <p>Official Toronto Public Health inspection records:</p>
                        <ul>
                            <li>Food safety scores</li>
                            <li>Inspection history</li>
                            <li>Violation records</li>
                            <li>Compliance ratings</li>
                        </ul>
                        <p>Ensures all recommended establishments meet health and safety standards.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        <i class="bi bi-calculator"></i> Scoring Algorithm
                    </h5>
                    <p>The hidden gem score combines multiple factors:</p>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Reddit Mentions (30%)</strong>
                            <p class="small text-muted">Community buzz and frequency</p>
                        </div>
                        <div class="col-md-3">
                            <strong>Sentiment (25%)</strong>
                            <p class="small text-muted">Positive vs negative mentions</p>
                        </div>
                        <div class="col-md-3">
                            <strong>DineSafe (25%)</strong>
                            <p class="small text-muted">Health inspection scores</p>
                        </div>
                        <div class="col-md-3">
                            <strong>Uniqueness (20%)</strong>
                            <p class="small text-muted">How "hidden" the gem is</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- API Testing -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold text-primary">🧪 API Testing</h2>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Interactive API Tester</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">GET</span>
                            <input type="text" class="form-control" id="apiUrl" value="/api/gems/top?limit=3" placeholder="Enter API endpoint">
                            <button class="btn btn-primary" onclick="testCustomEndpoint()">
                                <i class="bi bi-play"></i> Test
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="quickTest" onchange="loadQuickTest()">
                            <option value="">Quick Tests</option>
                            <option value="/api/gems/top?limit=3">Top 3 Gems</option>
                            <option value="/api/gems/mood/romantic?limit=2">Romantic Places</option>
                            <option value="/api/gems/type/bakery?limit=2">Bakeries</option>
                            <option value="/api/stats">Gems Statistics</option>
                            <option value="/api/events?limit=3">All Events</option>
                            <option value="/api/events/mood/cultural?limit=2">Cultural Events</option>
                            <option value="/api/events/mood/free?limit=2">Free Events</option>
                            <option value="/api/events/stats">Events Statistics</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div id="apiResponse" class="bg-light p-3 rounded" style="min-height: 100px; display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Response:</strong>
                            <span id="responseStatus" class="badge"></span>
                        </div>
                        <pre id="responseBody" class="mb-0"></pre>
                    </div>
                    
                    <div id="apiLoading" class="text-center py-4" style="display: none;">
                        <div class="loading"></div>
                        <p class="mt-2 text-muted">Testing API endpoint...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// API Testing Functions
function testEndpoint(endpoint) {
    showLoading();
    
    fetch(endpoint)
        .then(response => {
            const status = response.status;
            const statusClass = status === 200 ? 'bg-success' : 'bg-danger';
            document.getElementById('responseStatus').className = `badge ${statusClass}`;
            document.getElementById('responseStatus').textContent = `${status} ${response.statusText}`;
            
            return response.json();
        })
        .then(data => {
            showResponse(JSON.stringify(data, null, 2));
        })
        .catch(error => {
            document.getElementById('responseStatus').className = 'badge bg-danger';
            document.getElementById('responseStatus').textContent = 'Error';
            showResponse(`Error: ${error.message}`);
        });
}

function testCustomEndpoint() {
    const endpoint = document.getElementById('apiUrl').value;
    if (endpoint) {
        testEndpoint(endpoint);
    }
}

function loadQuickTest() {
    const select = document.getElementById('quickTest');
    const endpoint = select.value;
    if (endpoint) {
        document.getElementById('apiUrl').value = endpoint;
        testEndpoint(endpoint);
    }
}

function showLoading() {
    document.getElementById('apiResponse').style.display = 'none';
    document.getElementById('apiLoading').style.display = 'block';
}

function showResponse(response) {
    document.getElementById('apiLoading').style.display = 'none';
    document.getElementById('responseBody').textContent = response;
    document.getElementById('apiResponse').style.display = 'block';
}

// Special function for testing collect events (POST request)
function testCollectEvents() {
    showLoading();
    
    fetch('/api/collect-events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        const status = response.status;
        const statusClass = status === 200 ? 'bg-success' : 'bg-danger';
        document.getElementById('responseStatus').className = `badge ${statusClass}`;
        document.getElementById('responseStatus').textContent = `${status} ${response.statusText}`;
        
        return response.json();
    })
    .then(data => {
        showResponse(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        document.getElementById('responseStatus').className = 'badge bg-danger';
        document.getElementById('responseStatus').textContent = 'Error';
        showResponse(`Error: ${error.message}`);
    });
}

// Syntax highlighting for code blocks
document.addEventListener('DOMContentLoaded', function() {
    // Add copy buttons to code blocks
    document.querySelectorAll('pre code').forEach(block => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2';
        button.innerHTML = '<i class="bi bi-clipboard"></i>';
        button.onclick = () => {
            navigator.clipboard.writeText(block.textContent);
            button.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-clipboard"></i>';
            }, 2000);
        };
        
        const container = block.closest('pre');
        container.style.position = 'relative';
        container.appendChild(button);
    });
});
</script>
{% endblock %} 