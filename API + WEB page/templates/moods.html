{% extends "base.html" %}

{% block title %}Mood Explorer - Toronto Hidden Gems{% endblock %}

{% block content %}
<div class="mood-explorer">
    <!-- Hero Section -->
    <div class="hero mood-hero">
        <div class="container">
            <h1 class="display-4 mb-4 fade-in">Explore by Mood</h1>
            <p class="lead mb-5 slide-up">Discover Toronto's hidden gems based on your current vibe</p>
        </div>
    </div>

    <!-- Mood Cards Section -->
    <div class="container my-5">
        <div class="row g-4">
            {% for mood, count in stats.mood_distribution.items() %}
            <div class="col-md-4 mood-card-wrapper">
                <div class="card mood-card" data-mood="{{ mood.lower() }}">
                    <div class="mood-gradient" style="background: {{ mood|mood_gradient }}">
                        <div class="mood-icon">{{ mood|mood_emoji }}</div>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">{{ mood.title() }}</h3>
                        <p class="card-text">{{ count }} hidden gems</p>
                        <button class="btn btn-outline-primary mood-select-btn" data-mood="{{ mood.lower() }}">
                            Explore {{ mood.title() }} Spots
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Map Section -->
    <div class="container-fluid my-5">
        <div class="row">
            <div class="col-md-4">
                <div class="card mood-filters">
                    <div class="card-body">
                        <h3>Selected Moods</h3>
                        <div id="selected-moods" class="mb-4"></div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="show-all-gems">
                            <label class="form-check-label" for="show-all-gems">
                                Show all gems
                            </label>
                        </div>
                    </div>
                </div>
                <div id="gems-list" class="mt-4"></div>
            </div>
            <div class="col-md-8">
                <div class="card map-card">
                    <div class="card-body p-0">
                        <div id="map" style="height: 700px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .mood-explorer {
        min-height: 100vh;
    }

    .mood-hero {
        background: linear-gradient(135deg, var(--toronto-blue) 0%, var(--apple-blue) 100%);
        padding: 6rem 0;
    }

    .mood-card {
        border-radius: 20px;
        overflow: hidden;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mood-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .mood-gradient {
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .mood-icon {
        font-size: 4rem;
        opacity: 0.9;
        transform: scale(1);
        transition: all 0.3s ease;
    }

    .mood-card:hover .mood-icon {
        transform: scale(1.1);
    }

    .mood-select-btn {
        width: 100%;
        margin-top: 1rem;
    }

    .map-card {
        border-radius: 20px;
        overflow: hidden;
    }

    .mood-filters {
        border-radius: 20px;
    }

    #selected-moods {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .selected-mood-tag {
        background: var(--apple-light-gray);
        border-radius: 20px;
        padding: 0.5rem 1rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .selected-mood-tag:hover {
        background: var(--apple-gray);
        color: white;
    }

    #gems-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .gem-item {
        padding: 1rem;
        border-radius: 12px;
        background: white;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .gem-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Animations */
    .fade-in {
        animation: fadeIn 1s ease-out;
    }

    .slide-up {
        animation: slideUp 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

<!-- Map and Interaction Scripts -->
{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Mood gradients and emojis
    const moodStyles = {
        romantic: {
            gradient: 'linear-gradient(135deg, #FF6B6B 0%, #FFB8B8 100%)',
            emoji: 'üíë'
        },
        foodie: {
            gradient: 'linear-gradient(135deg, #FF9F1C 0%, #FFBF69 100%)',
            emoji: 'üçΩÔ∏è'
        },
        adventure: {
            gradient: 'linear-gradient(135deg, #2EC4B6 0%, #7DDCD3 100%)',
            emoji: 'üåü'
        },
        relaxing: {
            gradient: 'linear-gradient(135deg, #9381FF 0%, #B8B8FF 100%)',
            emoji: 'üåø'
        },
        cultural: {
            gradient: 'linear-gradient(135deg, #F72585 0%, #FF99D7 100%)',
            emoji: 'üé≠'
        },
        budget: {
            gradient: 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)',
            emoji: 'üí∞'
        }
    };

    let map;
    let markers = [];
    let selectedMoods = new Set();
    let allGems = [];

    // Initialize map
    document.addEventListener('DOMContentLoaded', function() {
        map = L.map('map').setView([43.6532, -79.3832], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Load initial data
        fetchGems();

        // Setup event listeners
        document.querySelectorAll('.mood-select-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const mood = this.dataset.mood;
                toggleMood(mood);
            });
        });

        document.getElementById('show-all-gems').addEventListener('change', function() {
            if (this.checked) {
                showAllGems();
            } else {
                updateMap();
            }
        });
    });

    function fetchGems() {
        fetch('/api/gems')
            .then(response => response.json())
            .then(data => {
                allGems = data.data;
                updateMap();
            });
    }

    function toggleMood(mood) {
        if (selectedMoods.has(mood)) {
            selectedMoods.delete(mood);
        } else {
            selectedMoods.add(mood);
        }
        updateSelectedMoodsUI();
        updateMap();
    }

    function updateSelectedMoodsUI() {
        const container = document.getElementById('selected-moods');
        container.innerHTML = '';
        selectedMoods.forEach(mood => {
            const tag = document.createElement('div');
            tag.className = 'selected-mood-tag';
            tag.innerHTML = `
                ${moodStyles[mood]?.emoji || 'üè∑Ô∏è'} ${mood}
                <span class="remove-mood">√ó</span>
            `;
            tag.onclick = () => toggleMood(mood);
            container.appendChild(tag);
        });
    }

    function updateMap() {
        // Clear existing markers
        markers.forEach(marker => marker.remove());
        markers = [];

        // Filter gems based on selected moods
        const showAll = document.getElementById('show-all-gems').checked;
        const filteredGems = showAll ? allGems : allGems.filter(gem => {
            if (selectedMoods.size === 0) return true;
            return Array.from(selectedMoods).some(mood => 
                gem.mood_tags?.toLowerCase().includes(mood.toLowerCase())
            );
        });

        // Update gems list
        updateGemsList(filteredGems);

        // Add new markers
        filteredGems.forEach(gem => {
            if (gem.latitude && gem.longitude) {
                const marker = L.marker([gem.latitude, gem.longitude])
                    .bindPopup(`
                        <strong>${gem.name}</strong><br>
                        ${gem.type}<br>
                        Score: ${gem.hidden_gem_score.toFixed(1)}<br>
                        <small>${gem.mood_tags}</small>
                    `);
                marker.addTo(map);
                markers.push(marker);
            }
        });

        // Adjust map bounds if there are markers
        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    function updateGemsList(gems) {
        const container = document.getElementById('gems-list');
        container.innerHTML = '';
        
        gems.slice(0, 10).forEach(gem => {
            const item = document.createElement('div');
            item.className = 'gem-item';
            item.innerHTML = `
                <h5>${gem.name}</h5>
                <p class="mb-1"><small>${gem.type}</small></p>
                <p class="mb-0">
                    <span class="badge bg-primary">${gem.hidden_gem_score.toFixed(1)}</span>
                    <small class="text-muted">${gem.mood_tags}</small>
                </p>
            `;
            item.onclick = () => {
                if (gem.latitude && gem.longitude) {
                    map.setView([gem.latitude, gem.longitude], 16);
                    markers.forEach(marker => {
                        if (marker.getLatLng().lat === gem.latitude && 
                            marker.getLatLng().lng === gem.longitude) {
                            marker.openPopup();
                        }
                    });
                }
            };
            container.appendChild(item);
        });
    }
</script>
{% endblock %}
{% endblock %} 